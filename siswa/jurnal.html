<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Refleksi - MindUp</title>
    
    <link rel="icon" href="../assets/logo.svg" type="image/svg+xml">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-blue: #0d6efd; 
            --dark-blue: #0a429b;
            --light-blue-bg: #f0f7ff;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-400: #94a3b8;
            --slate-600: #475569;
            --slate-800: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--slate-50);
            padding-top: 80px;
            color: var(--slate-800);
        }

        h1, h2, h3, h4, h5, .navbar-brand { font-family: 'Poppins', sans-serif; }

        /* --- NAVBAR STYLING (SAMA PERSIS DASHBOARD) --- */
        .navbar {
            background-color: white;
            box-shadow: 0 2px 15px rgba(0,0,0,0.03);
            min-height: 70px;
        }
        .navbar-brand { font-weight: 700; color: var(--primary-blue) !important; }
        
        .nav-profile-img { 
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-blue); 
        }

        /* --- TOMBOL KEMBALI KE BERANDA (CUSTOM) --- */
        .btn-nav-back {
            display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px;
            background-color: transparent; color: var(--slate-600); border: 1px solid var(--slate-300);
            border-radius: 50px; font-weight: 500; font-size: 0.85rem; text-decoration: none; 
            transition: all 0.3s ease;
            margin-right: 15px; /* Jarak dengan logo jika di desktop */
        }
        
        /* HOVER BIRU SESUAI PERMINTAAN */
        .btn-nav-back:hover { 
            background-color: var(--primary-blue); 
            color: white; 
            border-color: var(--primary-blue);
        }

        /* --- CARDS (LAYOUT JURNAL) --- */
        .journal-card, .history-wrapper-card {
            background: white; border-radius: 16px; border: 1px solid var(--slate-200);
            padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            height: 100%; display: flex; flex-direction: column;
        }
        
        /* Mood Styles */
        .mood-options { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 20px; }
        .mood-btn {
            flex: 1; border: 1px solid var(--slate-200); background: white; border-radius: 12px;
            padding: 10px 4px; text-align: center; cursor: pointer; transition: all 0.2s ease;
        }
        .mood-btn:hover { background-color: var(--slate-50); border-color: var(--slate-400); }
        .mood-emoji { font-size: 1.5rem; display: block; margin-bottom: 4px; }
        .mood-label { font-size: 0.65rem; font-weight: 600; color: var(--slate-600); text-transform: uppercase; letter-spacing: 0.5px; }
        .mood-btn.active { border-color: var(--primary-blue); background-color: var(--light-blue-bg); color: var(--primary-blue); box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.1); }
        
        .form-control-custom {
            background-color: var(--slate-50); border: 1px solid var(--slate-200); border-radius: 12px; padding: 16px; font-size: 0.95rem; resize: none; flex-grow: 1; 
        }
        .form-control-custom:focus { background-color: white; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1); }

        /* History Items */
        .history-content-area { flex-grow: 1; }
        .entry-container {
            position: relative; overflow: hidden; border-radius: 12px; margin-bottom: 12px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.3s ease;
            background: white; border: 1px solid var(--slate-200);
        }
        .entry-content-layer {
            position: relative; z-index: 10; background: white; padding: 14px 16px; 
            border-left: 4px solid #ccc; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .entry-date { font-size: 0.7rem; color: var(--slate-400); font-weight: 600; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px;}
        .entry-text { 
            font-size: 0.9rem; color: var(--slate-600); line-height: 1.5; white-space: pre-wrap; margin-bottom: 0;
            display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; line-clamp: 3; overflow: hidden;
        }
        .entry-mood-icon { font-size: 1.25rem; margin-right: 12px; line-height: 1; }

        /* Slide Actions (Edit/Delete) */
        .entry-actions-layer {
            position: absolute; top: 0; right: 0; bottom: 0; width: 120px; display: flex; background-color: var(--slate-100);
        }
        .action-btn {
            flex: 1; border: none; color: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer;
        }
        .btn-edit-slide { background-color: #f59e0b; } .btn-edit-slide:hover { background-color: #d97706; }
        .btn-delete-slide { background-color: #ef4444; } .btn-delete-slide:hover { background-color: #dc2626; }
        .entry-container.slide-active .entry-content-layer { transform: translateX(-120px); }

        /* Mood Border Colors */
        .mood-border-happy { border-left-color: #10b981; } .mood-border-neutral { border-left-color: #64748b; }
        .mood-border-sad { border-left-color: #3b82f6; } .mood-border-anxious { border-left-color: #f59e0b; }
        .mood-border-angry { border-left-color: #ef4444; }

        .btn-kebab {
            border: none; background: transparent; color: var(--slate-400); width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center; border-radius: 50%;
        }
        .btn-kebab:hover { background-color: var(--slate-100); color: var(--slate-600); }

        /* Pagination */
        .pagination-simple {
            margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--slate-100);
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-page-nav {
            border: 1px solid var(--slate-200); background: white; color: var(--slate-600);
            padding: 8px 16px; border-radius: 50px; font-size: 0.8rem; font-weight: 500; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-page-nav:hover:not(:disabled) { background-color: var(--slate-50); color: var(--slate-800); border-color: var(--slate-300); }
        .btn-page-nav:disabled { opacity: 0.5; cursor: not-allowed; background-color: var(--slate-50); }
        .page-info { font-size: 0.75rem; color: var(--slate-400); font-weight: 500; }

        @media (max-width: 991px) {
            .col-lg-5 { margin-top: 30px; }
            .journal-card { height: auto; min-height: 400px; } 
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">

            <a href="index.html" class="btn-nav-back d-none d-lg-inline-flex" style="background-color: var(--primary-blue); color: white; border-color: var(--primary-blue);">
                <i class="bi bi-arrow-left"></i> Kembali ke Beranda
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="d-lg-none py-2 border-bottom mb-2">
                     <a href="index.html" class="btn-nav-back w-100 justify-content-center">
                        <i class="bi bi-arrow-left"></i> Kembali ke Beranda
                    </a>
                </div>

                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item dropdown ms-lg-3">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <span class="me-2 d-none d-lg-block text-dark fw-bold" id="navUserName">Siswa MindUp</span>
                            <img src="https://ui-avatars.com/api/?name=Siswa+M&background=0d6efd&color=fff" alt="Profile" class="nav-profile-img" id="navUserImg">
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                            <li><a class="dropdown-item" href="profil.html"><i class="bi bi-person me-2"></i>Profil Saya</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="handleLogout()"><i class="bi bi-box-arrow-right me-2"></i>Keluar</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row h-100 align-items-stretch">
            
            <div class="col-lg-7 d-flex flex-column mb-3 mb-lg-0">
                <div class="mb-3">
                    <h4 class="fw-bold mb-1 text-dark">Tulis Jurnal Harian</h4>
                    <p class="text-muted small">Luangkan waktu sejenak untuk merefleksikan perasaanmu.</p>
                </div>

                <div class="journal-card h-100">
                    <div id="editModeAlert" class="alert alert-warning small d-flex align-items-center d-none mb-3 py-2" role="alert">
                        <i class="bi bi-pencil-fill me-2"></i> Mode Edit 
                        <a href="#" class="ms-auto fw-bold text-dark text-decoration-none" onclick="cancelEdit()">Batal</a>
                    </div>

                    <div class="mood-options">
                        <div class="mood-btn" onclick="selectMood('happy', this)"><span class="mood-emoji">üòÑ</span><span class="mood-label">Senang</span></div>
                        <div class="mood-btn" onclick="selectMood('neutral', this)"><span class="mood-emoji">üòê</span><span class="mood-label">Biasa</span></div>
                        <div class="mood-btn" onclick="selectMood('sad', this)"><span class="mood-emoji">üò¢</span><span class="mood-label">Sedih</span></div>
                        <div class="mood-btn" onclick="selectMood('anxious', this)"><span class="mood-emoji">üò∞</span><span class="mood-label">Cemas</span></div>
                        <div class="mood-btn" onclick="selectMood('angry', this)"><span class="mood-emoji">üò°</span><span class="mood-label">Marah</span></div>
                    </div>

                    <div class="mb-3 d-flex flex-column flex-grow-1">
                        <textarea id="journalText" class="form-control form-control-custom h-100" rows="6" placeholder="Ceritakan apa yang terjadi hari ini..."></textarea>
                    </div>

                    <button id="btnSave" class="btn btn-primary w-100 py-2 rounded-3 fw-bold shadow-sm" onclick="saveEntry()">
                        Simpan Jurnal <i class="bi bi-arrow-right-short ms-1"></i>
                    </button>
                </div>
            </div>

            <div class="col-lg-5 d-flex flex-column">
                <div class="mb-3 d-none d-lg-block" style="visibility: hidden;">
                    <h4 class="mb-1">Spacer</h4>
                    <p class="small">Spacer</p>
                </div>

                <div class="history-wrapper-card h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                        <h6 class="fw-bold m-0 text-dark">Riwayat Tulisan</h6>
                        <button class="btn btn-sm text-danger fw-bold" style="font-size: 0.75rem;" onclick="clearAllEntries()">
                            BERSIHKAN
                        </button>
                    </div>

                    <div class="history-content-area">
                        <div id="emptyState" class="text-center py-5 d-none">
                            <i class="bi bi-journal-album text-secondary display-4 mb-2"></i>
                            <p class="text-muted small">Belum ada catatan jurnal.</p>
                        </div>
                        <div id="historyList"></div>
                    </div>

                    <div id="paginationContainer" class="pagination-simple d-none">
                        <button class="btn-page-nav" id="btnPagePrev" onclick="prevPage()">
                            <i class="bi bi-chevron-left"></i> Sebelumnya
                        </button>
                        
                        <span class="page-info" id="pageIndicator">Halaman 1</span>

                        <button class="btn-page-nav" id="btnPageNext" onclick="nextPage()">
                            Selanjutnya <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // --- 1. SETUP & AUTH ---
        let selectedMood = null;
        let editingId = null; 
        const moodEmojis = { happy: 'üòÑ', neutral: 'üòê', sad: 'üò¢', anxious: 'üò∞', angry: 'üò°' };
        
        const ITEMS_PER_PAGE = 5; 
        let currentPage = 1;

        // Cek Login (Sama seperti Dashboard)
        const userRole = localStorage.getItem('userRole');
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        if (!isLoggedIn || userRole !== 'Siswa') {
            window.location.href = '../login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load Nama User
            const userName = localStorage.getItem('userName') || 'Sobat MindUp';
            document.getElementById('navUserName').innerText = userName;

            // Load Avatar (Menggunakan UI Avatars agar sama dengan dashboard)
            const initials = userName.split(" ").map((n)=>n[0]).join("+");
            const avatarUrl = `https://ui-avatars.com/api/?name=${initials}&background=0d6efd&color=fff`;
            document.getElementById('navUserImg').src = avatarUrl;

            renderHistory();
        });

        function handleLogout() {
            Swal.fire({
                title: 'Keluar?', text: "Sesi Anda akan diakhiri.", icon: 'question',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Ya, Keluar'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.clear();
                    window.location.href = '../login.html';
                }
            });
        }

        // --- 2. LOGIKA MOOD & SAVE ---
        function selectMood(mood, element) {
            selectedMood = mood;
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
        }

        function saveEntry() {
            const text = document.getElementById('journalText').value.trim();
            if (!selectedMood) return Swal.fire('Oops', 'Pilih mood dulu.', 'warning');
            if (!text) return Swal.fire('Oops', 'Isi dulu jurnalnya.', 'warning');

            // --- SIMULASI PENYIMPANAN KE "data/jurnal.json" ---
            // Catatan: JavaScript Client-Side TIDAK BISA menulis ke file server langsung.
            // Kita menggunakan localStorage sebagai simulasi database lokal.
            // Jika ada Backend, di sini Anda akan menggunakan fetch() POST ke API endpoint.

            let entries = JSON.parse(localStorage.getItem('mindup_entries')) || [];

            if (editingId) {
                // Edit Mode
                const index = entries.findIndex(e => e.id === editingId);
                if (index !== -1) {
                    entries[index].mood = selectedMood;
                    entries[index].text = text;
                    entries[index].updatedAt = new Date().toISOString(); // Opsional: timestamp update
                }
                Swal.fire({icon: 'success', title: 'Update Berhasil', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
                cancelEdit();
            } else {
                // New Entry
                const newEntry = {
                    id: Date.now(),
                    date: new Date().toLocaleString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'}),
                    mood: selectedMood,
                    text: text
                };
                entries.unshift(newEntry); // Tambah ke awal array
                Swal.fire({icon: 'success', title: 'Tersimpan', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
                currentPage = 1; // Reset ke halaman pertama saat input baru
            }

            // Simpan ke LocalStorage (Simulasi Database)
            localStorage.setItem('mindup_entries', JSON.stringify(entries));
            
            // Log untuk debug (menunjukkan struktur data JSON)
            console.log("Data Jurnal Tersimpan (Simulasi JSON):", JSON.stringify(entries, null, 2));

            resetForm();
            renderHistory();
        }

        function resetForm() {
            document.getElementById('journalText').value = '';
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active'));
            selectedMood = null;
        }

        // --- 3. RENDER HISTORY & PAGINATION ---
        function renderHistory() {
            const container = document.getElementById('historyList');
            const emptyState = document.getElementById('emptyState');
            const paginationContainer = document.getElementById('paginationContainer');
            
            // Ambil data dari LocalStorage
            const entries = JSON.parse(localStorage.getItem('mindup_entries')) || [];

            container.innerHTML = '';

            if (entries.length === 0) {
                emptyState.classList.remove('d-none');
                paginationContainer.classList.add('d-none');
            } else {
                emptyState.classList.add('d-none');
                paginationContainer.classList.remove('d-none');

                const totalPages = Math.ceil(entries.length / ITEMS_PER_PAGE);
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                const start = (currentPage - 1) * ITEMS_PER_PAGE;
                const end = start + ITEMS_PER_PAGE;
                const paginatedEntries = entries.slice(start, end);

                paginatedEntries.forEach(entry => {
                    const moodBorder = `mood-border-${entry.mood}`;
                    const emoji = moodEmojis[entry.mood];

                    const html = `
                        <div class="entry-container" id="card-${entry.id}">
                            <div class="entry-actions-layer">
                                <button class="action-btn btn-edit-slide" onclick="editEntry(${entry.id})"><i class="bi bi-pencil-square fs-5 mb-1"></i> Edit</button>
                                <button class="action-btn btn-delete-slide" onclick="deleteEntry(${entry.id})"><i class="bi bi-trash fs-5 mb-1"></i> Hapus</button>
                            </div>
                            <div class="entry-content-layer ${moodBorder}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="entry-date">${entry.date}</div>
                                    <button class="btn-kebab" onclick="toggleSlide(${entry.id})"><i class="bi bi-three-dots"></i></button>
                                </div>
                                <div class="d-flex align-items-start">
                                    <span class="entry-mood-icon">${emoji}</span>
                                    <p class="entry-text text-truncate-3">${entry.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });

                updatePaginationButtons(totalPages);
            }
        }

        function updatePaginationButtons(totalPages) {
            const btnPrev = document.getElementById('btnPagePrev');
            const btnNext = document.getElementById('btnPageNext');
            const indicator = document.getElementById('pageIndicator');

            btnPrev.disabled = currentPage === 1;
            btnNext.disabled = currentPage === totalPages;
            
            indicator.innerText = `Halaman ${currentPage} dari ${totalPages}`;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderHistory();
            }
        }

        function nextPage() {
            const entries = JSON.parse(localStorage.getItem('mindup_entries')) || [];
            const totalPages = Math.ceil(entries.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderHistory();
            }
        }

        // --- 4. AKSI EDIT & DELETE ---
        function toggleSlide(id) {
            const card = document.getElementById(`card-${id}`);
            // Tutup kartu lain yang sedang terbuka
            document.querySelectorAll('.entry-container').forEach(c => {
                if (c.id !== `card-${id}`) c.classList.remove('slide-active');
            });
            card.classList.toggle('slide-active');
        }

        function editEntry(id) {
            const entries = JSON.parse(localStorage.getItem('mindup_entries')) || [];
            const entry = entries.find(e => e.id === id);
            if (entry) {
                document.getElementById('journalText').value = entry.text;
                selectedMood = entry.mood;
                
                // Set tombol mood aktif
                document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active'));
                const moods = ['happy', 'neutral', 'sad', 'anxious', 'angry'];
                const btns = document.querySelectorAll('.mood-btn');
                const idx = moods.indexOf(entry.mood);
                if(idx >= 0) btns[idx].classList.add('active');

                editingId = id;
                document.getElementById('btnSave').innerHTML = 'Update Jurnal <i class="bi bi-pencil-square ms-1"></i>';
                document.getElementById('editModeAlert').classList.remove('d-none');
                
                // Tutup slide action
                toggleSlide(id);
                // Scroll ke atas
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function cancelEdit() {
            editingId = null;
            resetForm();
            document.getElementById('btnSave').innerHTML = 'Simpan Jurnal <i class="bi bi-arrow-right-short ms-1"></i>';
            document.getElementById('editModeAlert').classList.add('d-none');
        }

        function deleteEntry(id) {
            Swal.fire({
                title: 'Hapus?', text: "Yakin mau dihapus?", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Hapus'
            }).then((r) => {
                if (r.isConfirmed) {
                    let entries = JSON.parse(localStorage.getItem('mindup_entries')) || [];
                    entries = entries.filter(e => e.id !== id);
                    localStorage.setItem('mindup_entries', JSON.stringify(entries));
                    if (editingId === id) cancelEdit();
                    renderHistory();
                }
            });
        }

        function clearAllEntries() {
            if (!localStorage.getItem('mindup_entries')) return;
            Swal.fire({
                title: 'Hapus Semua?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Bersihkan'
            }).then((r) => { if (r.isConfirmed) { localStorage.removeItem('mindup_entries'); cancelEdit(); renderHistory(); } });
        }
    </script>
</body>
</html>